name: Build Crowd Organ host

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-host:
    runs-on: ubuntu-22.04
    env:
      OF_VERSION: v0.11.2
      OF_FLAVOR: of_v0.11.2_linux64gcc6_release
      OF_ROOT: ${{ github.workspace }}/openFrameworks
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar build-essential

      - name: Fetch openFrameworks
        run: |
          mkdir -p "${OF_ROOT}"
          wget --quiet https://openframeworks.cc/versions/${OF_VERSION}/${OF_FLAVOR}.tar.gz
          tar -xzf ${OF_FLAVOR}.tar.gz
          shopt -s dotglob
          mv ${OF_FLAVOR}/* "${OF_ROOT}"/
          shopt -u dotglob
          rm -rf "${OF_FLAVOR}"

      - name: Install openFrameworks packages
        run: |
          cd "${OF_ROOT}/scripts/linux/ubuntu"
          sudo tee /etc/needrestart/conf.d/90-ci-auto.conf > /dev/null <<'EOF'
            $nrconf{restart} = 'l';
          EOF
          # Clean out packages that disappeared from supported Ubuntu repos so
          # the legacy helper scripts do not explode mid-run.
          python - <<'PY'
            import re
            from pathlib import Path

            path = Path("install_dependencies.sh")
            text = path.read_text()
            replacements = (
                (r"\blibgconf-2-4\b", ""),
                # qt5-default vanished after Ubuntu 20.04. Swap in the modern toolchain
                # meta packages so Qt-based openFrameworks addons still build.
                (r"\bqt5-default\b", "qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools"),
            )

            for pattern, repl in replacements:
                text = re.sub(pattern, repl, text)

            path.write_text(text)
          PY
          sudo env "DEBIAN_FRONTEND=noninteractive" "NEEDRESTART_MODE=a" ./install_dependencies.sh > install.log
          sudo env "DEBIAN_FRONTEND=noninteractive" "NEEDRESTART_MODE=a" ./install_codecs.sh >> install.log
          cat install.log

      - name: Build CrowdOrganHost
        run: |
          mkdir -p "${OF_ROOT}/apps/myApps"
          cp -R of_app "${OF_ROOT}/apps/myApps/CrowdOrganHost"
          cd "${OF_ROOT}/apps/myApps/CrowdOrganHost"
          make Release
